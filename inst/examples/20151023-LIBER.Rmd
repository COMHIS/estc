---
title: "LIBER Analysis"
author: "Leo Lahti"
date: "23/10/2015"
output: markdown_document
---

## LIBER Analyses


```{r summaryinit, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE}
library(stringr)
library(bibliographica)
library(estc)
#df <- read.csv(file = "estc.csv", sep = "|")
df <- read.csv(file = "estc-LIBER20151023-backup.csv", sep = "|")

# Order the levels where necessary
df$gatherings.original <- order_gatherings(df$gatherings.original)
df$gatherings <- order_gatherings(df$gatherings)
df.preprocessed <- df
```

This document provides a reproducible summary of the ESTC history data set (the preprocessed data set covers ```r nrow(df.preprocessed)``` documents) as prepared for our [Liber Quarterly article](http://liber.library.uu.nl/index.php/lq) ([Tolonen](https://github.com/tolonen), [Ilomäki](https://github.com/NVI/), [Lahti](http://www.iki.fi/Leo.Lahti); in review). See also further analyses of this data collection listed in the [README file](https://github.com/rOpenGov/estc). For details on the data and analysis, see the manuscript (link will be added here when the article is out!). Do not hesitate to contact us if you have questions.

### Reproducing the analyses

The ESTC data set obtained from the British Library is not public. If you have access to the ESTC data, you can reproduce the analyses by first cloning this repository and parsing the raw data file ([instructions](https://github.com/rOpenGov/estc/blob/master/vignettes/tutorial.md)). Note that this workflow is updated with new information and is under constant improvement; therefore the figures are not necessarily identical to the ones shown in the publication. Full details for reproducing the figures are in the [Rmarkdown source code](https://github.com/rOpenGov/estc/blob/master/inst/examples/20151023-LIBER.Rmd). After parsing the raw data file and installing the required R packages, you can run the following commands in R (use the inst/examples folder of this repository as the working directory) to generate all the figures:


```{r, echo=TRUE, message=FALSE, warning=FALSE, eval=FALSE}
library(knitr)
knit("20151023-LIBER.Rmd")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(rmarkdown)
library(knitr)
library(ggplot2)
library(estc)
library(bibliographica)
opts_chunk$set(cache=TRUE)
library(dplyr)
library(ggthemes)
#ggplot_set(theme_bw(20))
df <- df.preprocessed
df <- df.preprocessed <- df[-which(df$publication_year < 1470),] 
```



## Who wrote history ?

### Authors who published the most history titles according to the ESTC

Specific authors are highlighted:

```{r 20151023LIBER-1, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=6, fig.width=8}
library(ggplot2)
library(dplyr)
dfs <- filter(df.preprocessed, !is.na(author_birth) & !is.na(author_death))
theme_set(theme_bw(50))
selected.authors <- c("prynne, william (1600-1669)", "defoe, daniel (1661-1731)", "hume, david (1711-1776)", "hume, david (1560-1630)")
top <- names(rev(sort(table(dfs$author_unique))))[1:20]
top <- c(top, "hume, david (1560-1630)")
#top <- setdiff(top, "caesar, julius (-100- -44)")
#top <- setdiff(top, "caesar, julius (NA-NA)")
dfs <- filter(dfs, author_unique %in% top)
p <- top_plot(dfs, "author_unique", ntop = 30, highlight = selected.authors)
p <- p + guides(fill = "none")
p <- p + ylab("Title count")
p <- p + scale_fill_manual(values = c("darkgray", "black"))
p <- p + ggtitle("Top early modern history authors in ESTC")
print(p)
```


### The life spans of the top authors based on the title count

The visualization also reveals ambiguities arising from authors having the same name but living at different times (e.g. David Hume)

```{r 20151023LIBER-2, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=5, fig.width=7.5}
theme_set(theme_bw(20))
dfa <- dfs[, c("author_name", "author_unique", "author_birth", "author_death")]
dfa <- dfa[!duplicated(dfa), ]
#dfa <- dfa[match(names(a), dfa$author_name),]
dfa <- arrange(dfa, author_birth)
# Order authors by birth year
dfa$author_name <- factor(dfa$author_name, levels = unique(dfa$author_name))
dfa$index <- sample(factor(1:nrow(dfa)))
dfa$fill <- rep("black", nrow(dfa))
dfa$fill[dfa$author_unique %in% selected.authors] <- "red"

p <- ggplot(dfa)
p <- p + geom_segment(aes(y = author_name, yend = author_name, x = author_birth, xend = author_death, color = fill), size = 2) 
p <- p + theme(axis.text.y = element_text(size = 14))
p <- p + xlab("Author life span (year)") + ylab("")
p <- p + guides(color = FALSE)
p <- p + scale_color_manual(values = c("darkgray", "black"))
p <- p + ggtitle("Top early modern author life span")
print(p)
```


### The title counts per year for selected authors

William Prynne, Daniel Defoe and David Hume (highlighted in Figures 1 and 2) provide an overview of their publishing activity up until 1800.

```{r 20151023LIBER-3, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=4, fig.width=10}
theme_set(theme_bw(20))
dfs <- df.preprocessed %>%
         filter(author_unique %in% selected.authors) %>%
	 group_by(author_unique, publication_decade) %>%
	 tally() %>%
	 arrange(publication_decade)

# Rearrange author levels
dfs$author_unique <- factor(dfs$author_unique, levels = c("prynne, william (1600-1669)", "hume, david (1560-1630)", "defoe, daniel (1661-1731)", "hume, david (1711-1776)"))
theme_set(theme_bw(20))

# Barplot version
p2 <- ggplot(dfs, aes(x = publication_decade, y = n, fill = author_unique)) +
       geom_bar(stat = "identity", position = "stack", color = "black") +
       xlab("Publication Year") +
       ylab("Title Count")
p2 <- p2 + scale_fill_manual(values = c("black", "darkgray", "lightgray", "white"))
p2 <- p2 + guides(fill = guide_legend("Author"))
p2 <- p2 + ggtitle("Title count timeline for selected authors")
p2
```


### Title count versus paper consumption among the highlighted authors

The visualization reveals the nature of the author’s publications, distinguishing pamphleteering (many titles, few pages) and the authoring of books (fewer titles, more pages).

```{r 20151023LIBER-4, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=6, fig.width=7}
theme_set(theme_bw(20))
dfs <- df.preprocessed
#dfs$gatherings <- harmonize_names(dfs$gatherings, gatherings_table(),
#	       	  		  from = "Standard", to = "Name")$name
#dfs <- dfs %>% filter(gatherings %in% c("folio", "octavo"))
dfs <- dfs %>% filter(author_unique %in% topa) %>%
       	   filter(!is.na(author_birth) & !is.na(author_death))
dfs <- dfs %>%
       	        group_by(author_unique) %>%
	        summarize(titles = n(),
	        paper = sum(paper.consumption.km2, na.rm = T))
dfs$highlight <- rep("darkgray", nrow(dfs))
dfs$highlight[dfs$author_unique %in% selected.authors] <- "black"
p <- ggplot(dfs, aes(x = titles, y = paper, color = highlight)) 
p <- p + geom_text(aes(label = author_unique), size = 7) 
p <- p + scale_color_manual(values = rev(c("darkgray", "black")))
p <- p + guides(color = "none") 
p <- p + xlim(c(-68, 210)) 
p <- p + scale_x_continuous(breaks = c(-70, 0, 50, 100, 150), labels = c("", "0", "50", "100", "150"), limits = c(-70, 214))       
p <- p + xlab("Title count") 
p <- p + ylab("Paper consumption (km2)")
p <- p + ggtitle("Title count versus paper (authors)")
print(p)	 
```


### The most active known female authors based on the title count

The gender is inferred automatically from the first names

```{r 20151023LIBER-5, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=6, fig.width=8}
theme_set(theme_bw(20))
dfs <- df.preprocessed %>% filter(author_gender == "female")
dfs <- dfs[-c(grep("jean", dfs$author_unique), grep("pierre", dfs$author_unique), grep("capriata", dfs$author_unique), grep("mesurier", dfs$author_unique), grep("bouhours", dfs$author_unique)),]

dfs$author_unique <- gsub("whitrowe, joan \\(NA-NA\\)", "whitrowe, joan (1630-1707)", dfs$author_unique)

# Withrow, Joan (1630-1707)
# bouhours is male
#Pier Giovanni Capriata is male
#Le Mesurier, Havilland is male 
p <- top_plot(dfs, "author_unique", ntop = 20)
p <- p + scale_fill_manual(values = "black")
p <- p + guides(fill = "none")
p <- p + ylab("Title count")
p <- p + ggtitle("Top female authors")
p <- p + theme(axis.text.x = element_text(size = 16), axis.text.y = element_text(size = 16), axis.title.x = element_text(size = 25), axis.title.y = element_text(size = 22), title = element_text(size = 22))
print(p)	 
```

## Where was history published ?

### Publication volumes at the top publication locations in Britain and Ireland, 1470-1800

The UK map was generated by taking a screencapture of a video produced by running the [analysis code](20151023-LIBER-video.R):

```{r 20151023LIBER-video, echo=TRUE, message=FALSE, cache=FALSE, eval = FALSE}
source("20151023-LIBER-video.R")
```

The circle diameter corresponds to the logarithm (log10) of the title count. You can also [download and view the full video](https://raw.githubusercontent.com/rOpenGov/estc/master/inst/examples/liber.mp4).

![UK1700](uk1700.png)


### The top publication places ranked by the title count

```{r 20151023LIBER-topplace, echo=FALSE, message=FALSE, cache=FALSE, fig.height=5, fig.width=5}
theme_set(theme_bw(30))
dfs <- df
p <- top_plot(dfs, "publication_place", ntop = 20)
p <- p + scale_fill_manual(values = "black")
p <- p + guides(fill = "none")
p <- p + ylab("Title count (Log10 scale)")
p <- p + scale_y_log10()
p <- p + ggtitle("Top publication places")
print(p)	 
```



### Title count and overall paper consumption in the top publication locations

The current country of origin is indicated.

```{r 20151023LIBER-8, echo=FALSE, message=FALSE, cache=FALSE, fig.height=6, fig.width=8}
theme_set(theme_bw(20))
top <- names(rev(sort(table(df$publication_place))))[1:50]
dfs <- df %>% filter(publication_place %in% top) %>% group_by(publication_place) %>% summarize(titles = n(), paper = sum(paper.consumption.km2, na.rm = T))
dfs$country <- get_country(dfs$publication_place)$country
dfs$usa <- dfs$country == "USA"
p <- ggplot(dfs, aes(x = log10(titles), y = log10(paper)))
p <- p + geom_text(aes(label = publication_place, color = usa), size = 5)
p <- p + xlim(c(1.2, log10(max(na.omit(dfs$titles[!is.infinite(dfs$titles)])))))
p <- p + xlab("Title Count") + ylab("Paper consumption (km2)")
p <- p + scale_color_manual(values = c("darkgray", "black"))
p <- p + guides(color = "none")
p <- p + ggtitle("Title count versus paper (places)")
print(p)	 
```



### Title count and paper consumption in Ireland, Scotland and the USA

```{r 20150611paris-places4, message=FALSE, fig.height=5, fig.width=10, echo=FALSE}
theme_set(theme_bw(20))
df2 <- df.preprocessed %>%
    filter(!is.na(publication_country)) %>%
    group_by(publication_country) %>%
    summarize(paper = sum(paper.consumption.km2, na.rm = TRUE),
	      docs = n()) %>%
    arrange(desc(docs)) %>%
    filter(publication_country %in% c("Scotland", "Ireland", "USA"))

p1 <- ggplot(df2, aes(x = publication_country, y = docs)) + geom_bar(stat = "identity") + ggtitle("Title count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ylab("Documents") + xlab("")
p2 <- ggplot(df2, aes(x = publication_country, y = paper)) + geom_bar(stat = "identity") + ggtitle("Paper consumption") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ylab("Paper (km2)") + xlab("")
grid.arrange(p1, p2, nrow = 1)
```        



## How does publishing change ?

### Publishing activity among all ESTC documents (balls) and History documents (triangles)

A comparison between the title count for history publications and for all documents in the ESTC catalogue, 1470-1800.

```{r 20151023LIBER-14, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, fig.width=8, fig.height=4}
# Compare to overall publication stats
# 1470 - 1790
library(gdata)
pubstat <- read.xls("data/Copy\ of\ simons-ESTC-1477-1800.xlsx")

# Remove duplicated titles
tmp <- df[, c("publication_year", "title")]
tmp <- tmp[!duplicated(tmp), ]
pubyears.history <- table(tmp$publication_year)

years <- 1470:1799
dff <- data.frame(list(year = years, 
              ESTC.yearly = pubstat$ESTC.yearly[match(years, pubstat$Year)],
	      ESTC.history = as.numeric(pubyears.history[match(years, names(pubyears.history))])))
dff$decade <- round(dff$year, -1)
library(reshape)
dfm <- melt(dff, id = c("year", "decade"))
dfi <- aggregate(dfm[, "value"], by = dfm[, c("variable", "decade")], sum)
dfi$documents.total <- dfi$x
dfi$documents.annual <- dfi$x/10
theme_set(theme_bw(20))
p <- ggplot(dfi, aes(x = decade, y = x, shape = variable))
p <- p + geom_point(size = 4) + geom_smooth(size = 1, color = "black")
p <- p + xlab("Year") + ylab("Publications per decade")
p <- p + ggtitle("History versus all publishing 1470-1800")
p <- p + scale_color_manual(values=c("#CC6666", "#9999CC"))
p <- p + guides(color = "none", shape = "none")
p2 <- p
print(p2)
```



```{r 20151023LIBER-10a, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=4, fig.width=8}
library(sorvi)
dfs <- df.preprocessed %>% filter(publication_year >= 1470) %>% 
         group_by(publication_year) %>%
         summarize(titles = n(), paper = sum(paper.consumption.km2, na.rm = T))
#p1 <- regression_plot(titles ~ publication_year, data = dfs)
p1 <- ggplot(dfs, aes(y = titles, x = publication_year))
p1 <- p1 + geom_smooth(color = "black") + geom_point()
p1 <- p1 + xlab("Publication Year") + ylab("Title Count") 
p1 <- p1 + theme(axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20))
p1 <- p1 + theme(axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20))
p1 <- p1 + guides(fill = "none", alpha = "none")
p1 <- p1 + ggtitle("History publications 1470-1800: title count")
print(p1)
```



```{r 20151023LIBER-10b, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=4, fig.width=8.2}
#p2 <- regression_plot(paper ~ publication_year, data = dfs) +
p2 <- ggplot(dfs, aes(y = paper, x = publication_year))
p2 <- p2 + geom_smooth(color = "black") + geom_point() +
       xlab("Publication Year") +
       ylab("Paper Consumption (km2)")
       
p2 <- p2 + theme(axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20))
p2 <- p2 + theme(axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20))
p2 <- p2 + guides(fill = "none", alpha = "none")
p2 <- p2 + ggtitle("History publications 1470-1800: paper consumption")
print(p2)
```


### Average paper consumption per document in history publications, 1470-1800

```{r 20151023LIBER-11, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=4, fig.width=8}
theme_set(theme_bw(20))
library(sorvi)
dfs <- df %>% filter(publication_year >= 1470) %>% 
         group_by(publication_year) %>%
         summarize(paper.per.doc = mean(paper.consumption.km2, na.rm = T))

p <- ggplot(dfs, aes(y = paper.per.doc, x = publication_year)) +
       geom_line() + geom_point() +
       xlab("Publication Year") + ylab("Paper per document")
p <- p + ggtitle("Average paper consumption per document")
print(p)
```




### Paper consumption in books (balls) versus pamphlets (triangles), 1470-1800

```{r 20151023LIBER-12, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=6, fig.width=9}
df2 <- df
df2$document.type <- rep(NA, nrow(df2))
df2$document.type[df2$pagecount > 32] <- "book"
df2$document.type[df2$pagecount <= 32] <- "pamphlet"
df2 <- df2[which(!is.na(df2$document.type)),]
df2$document.type <- factor(df2$document.type)
df2 <- df2 %>% group_by(publication_decade, document.type) %>% summarize(paper.consumption.km2 = sum(paper.consumption.km2, na.rm = TRUE), n = n()) 
p <- ggplot(df2, aes(x = publication_decade, y = paper.consumption.km2, group = document.type))
p <- p + geom_point(aes(shape = document.type), size = 5)
p <- p + geom_smooth(method = "loess", color = "black")
p <- p + ggtitle("Paper consumption per document type")
p <- p + xlab("Year")
p <- p + ylab("Paper consumption (km2)")
p <- p + scale_color_manual(values=c("black", "darkgray"))
p <- p + guides(shape = "none")
p <- p + ggtitle("Books versus pamphlets: paper consumption 1470-1800")
print(p)
```


### Paper consumption for different document formats over time

Each point represents a decade. Loess smoothing.

```{r 20151023LIBER-13, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, fig.width=11, fig.height=6}
df2 <- df %>% group_by(publication_decade, gatherings) %>% summarize(paper.consumption.km2 = sum(paper.consumption.km2, na.rm = TRUE), n = n()) 
df2 <- filter(df2, gatherings %in% setdiff(names(which(table(df2$gatherings) >= 15)), "NA"))
p <- ggplot(df2, aes(y = paper.consumption.km2, x = publication_decade, shape = gatherings, linetype = gatherings))
p <- p + geom_point(size = 4)
p <- p + geom_smooth(method = "loess", size = 1, color = "black")
p <- p + ggtitle("Paper consumption in time by gatherings")
p <- p + xlab("Year")
p <- p + ylab("Paper consumption (km2)")
p <- p + guides(linetype = guide_legend(keywidth = 5), shape = guide_legend(keywidth = 5))
p <- p + ggtitle("Paper consumption for different document formats")
print(p)
```

### Title count between the octavo versus the folio format among the top authors

```{r 20151023LIBER-3b, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=7, fig.width=7}
library(tidyr)
dfs <- df
top <- names(rev(sort(table(df$author_unique))))[1:20]
top <- c(top, "hume, david (1560-1630)")
top <- setdiff(top, "caesar, julius (NA-NA)")
topa <- top

# 2long/2fo/2small -> folio; 8vo -> octavo
dfs$gatherings <- harmonize_names(dfs$gatherings, gatherings_table(),
	       	  		from = "Standard", to = "Name")$name
dfs <- dfs %>% filter(author_unique %in% top &
	        gatherings %in% c("folio", "octavo")) %>%
	 group_by(author_unique, gatherings) %>%
	 tally() %>%
	 spread(gatherings, n)
dfs$highlight <- dfs$author_unique %in% c(selected.authors, "burke, edmund (1729-1797)")
dfs[is.na(dfs)] <- 0
dfs[dfs$author_unique == "hume, david (1560-1630)","highlight"] <- FALSE
dfs$size <- 2 + 1*as.numeric(dfs$highlight)

theme_set(theme_bw(20))
p <- ggplot(dfs, aes(x = folio, y = octavo)) +
       geom_text(aes(label = author_unique, color = highlight, size = size)) +       
       xlab("Folio") + ylab("Octavo") +
       guides(color = "none", size = "none") + 
       scale_color_manual(values = c("darkgray", "black")) +
       xlim(-21,max(dfs$folio) + 8) +
       scale_size(range = c(4,7))
p <- p + scale_x_continuous(breaks = c(-20, 0, 20, 40), labels = c("", "0", "20", "40"), limits = c(-20, 40))       
p <- p + ggtitle("Octavo vs Folio: top authors")
print(p)
```

### Edinburgh publishing

The publishing of historical works in Edinburgh on a timeline highlighting the eras of the English Civil War (1642-1651), the Restoration (1660), the Glorious Revolution (1688-1689), the Union Debates (1705-1706) and American Independence (1776).

```{r 20151023LIBER-Edinburgh, echo=FALSE, warning=FALSE, fig.width=11, fig.height=4}
# Scotland publishing summaries
library(ggplot2)
library(tidyr)
library(dplyr)
library(reshape2)
library(estc)
library(bibliographica)
library(dplyr)

# Complete data
dfo <- df.preprocessed
# Pick Scotland documents only
selected_place <- "Edinburgh"
country <- "Scotland"
df <- filter(dfo, publication_country == country & publication_year >= 1470)
# Use 5 year intervals
df <- filter(dfo, publication_country == country & publication_year >= 1470)
timeinterval <- 5
df$publication.timeunit <- round(df$publication_year/timeinterval)*timeinterval 
publications <- tapply(df$unity, list(df$publication.timeunit, df$publication_place), sum)
publications[is.na(publications)] <- 0 # Set NAs to 0
publications <- publications/timeinterval # Instead of decadal sum, use average annual output 
dfm <- melt(publications) 
names(dfm) <- c("Time", "Place", "Documents")
dfm <- filter(dfm, Place == selected_place)
dfm <- transform(dfm, date = as.character(Time))
dfs <- spread(dfm, Place, Documents)
dfs$date <- as.numeric(as.character(dfs$date))
dfs$varname <- dfs[[selected_place]]

# Custom highlight for specific time intervals
rect_left <- c(min(na.omit(dfs$date)),
               1642, 1651+1, 
               1660, 1660+1,
               1688, 1689+1,
               1706, 1707+1,
               1776, 1776+1,
               max(na.omit(dfs$date)))
  rectangles <- data.frame(
    xmin = rect_left[-length(rect_left)],
    xmax = rect_left[-1],
    ymin = min(dfs$varname),
    ymax = max(dfs$varname))
  rectangles$shade <- rep(c("White", "Highlight"), length = nrow(rectangles))


# Draw Figure
theme_set(theme_bw(20))
p <- ggplot()
p <- p + geom_rect(data = rectangles, 
	   aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax, fill=shade), alpha=0.8) + 
         scale_fill_manual(values = c("gray", "white")) +
         guides(fill = "none") 
p <- p + geom_line(data = dfs, aes(x = date, y = varname), col = "black")
p <- p + geom_point(data = dfs, aes(x = date, y = varname), col = "black")
p <- p + scale_x_continuous(breaks=seq(min(dfs$date), max(dfs$date), 20))
p <- p + ggtitle(paste("Publishing activity in ", selected_place))
p <- p + ylab("Documents / Year")
p <- p + ggtitle("History publishing in Edinburgh 1470-1800")
print(p)
```

## Session info

This document was created with the following versions:

```{r sessioninfo, message=FALSE, warning=FALSE}
sessionInfo()
```
