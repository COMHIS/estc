# Stats for our custom list
myfield <- "paper"
res0 <- timeline(df0, field = myfield, nmin = 0, mode = "absolute") 
fig0 <- res0$plot
tab0 <- res0$table
tab0$group <- rep("Custom", nrow(tab0))

# Stats in the complete data set
# Limit the analysis on the same time window
tab <- timeline(df.preprocessed, field = myfield, nmin = 0, mode = "absolute")$table
tab$group <- rep("ESTC", nrow(tab))
tab <- subset(tab, publication_time >= min(tab0$publication_time) &
                   publication_time <= max(tab0$publication_time))

df <- bind_rows(tab, tab0)
df$group <- factor(df$group)
df <- df %>% select(publication_time, group, absolute) %>% 
             spread(key = "group", value = "absolute", fill = 0) 
df <- df %>%mutate(fraction = 100 * Custom/ESTC)

p <- ggplot(df, aes(y = fraction, x = publication_time)) + 
       geom_bar(stat = "identity") + 
       ylab("Fraction of total documents (%)")  + 
       xlab("Publication time") +
	     ggtitle("Relative to all documents") 

p1 <- fig0 + ylab("Paper (sheets)") + ggtitle("Absolute")
p2 <- p
grid.arrange(p1, p2, nrow = 1)
# TODO could make custom function to show relative fraction compared
# to the complete database
# now done manually here.

# Stats for our custom list
myfield <- "titlecount"

res0 <- timeline(df0, field = myfield, nmin = 0, mode = "absolute") 
fig0 <- res0$plot
tab0 <- res0$table
tab0$group <- rep("Custom", nrow(tab0))

# Stats in the complete data set
# Limit the analysis on the same time window
tab <- timeline(df.preprocessed, field = myfield, nmin = 0, mode = "absolute")$table
tab$group <- rep("ESTC", nrow(tab))
tab <- subset(tab, publication_time >= min(tab0$publication_time) &
                   publication_time <= max(tab0$publication_time))

df <- bind_rows(tab, tab0)
df$group <- factor(df$group)
df <- df %>% select(publication_time, group, absolute) %>% 
             spread(key = "group", value = "absolute", fill = 0) 
df <- df %>%mutate(fraction = 100 * Custom/ESTC)

p <- ggplot(df, aes(y = fraction, x = publication_time)) + 
       geom_bar(stat = "identity") + 
       ylab("Fraction of total documents (%)")  + 
       xlab("Publication time") +
	     ggtitle("Relative to all documents") 

p1 <- fig0 + ylab("Title count (n)") + ggtitle("Absolute")
p2 <- p
grid.arrange(p1, p2, nrow = 1)
### Top publication places

```{r topplaces, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7, fig.height=5}
df <- df0
p <- top_plot(df, "publication_place", ntop)
p <- p + ggtitle(paste("Top publication places"))
p <- p + ylab("Title count (n)")
v <- 10^(1:max(na.omit(round(log10(df0$paper)))))
p <- p + scale_y_log10(breaks = v, labels = v)
print(p)
```

```{r toptitles, echo=FALSE, message=FALSE, warning=FALSE, fig.width=11, fig.height=5}
df <- df0
# Limit title length
df$title <- substr(as.character(df$title), 1, nchar)
p <- top_plot(df, "title", ntop = ntop) +
  ggtitle(paste("Top titles")) +
  scale_y_log10() +  
  ylab("Title count (n)")
print(p)
```







### Timeline for paper consumption

```{r paper, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, cache=FALSE, fig.width=9, fig.height=7}
#df <- df0
#res <- timeline(df, field = "paper", nmin = 0, mode = "absolute") 
#print(res$plot + ylab("Paper (sheets)"))
#df <- df0
#v <- 10^(1:max(na.omit(round(log10(df$paper)))))
#p <- ggplot(df, aes(x = paper)) +
#       geom_histogram() +
#       xlab("Paper (sheets)") + ylab("Title count (n)") +
#       scale_x_log10(breaks = v, labels = v, limits = c(min(v), 1.1*max(v))) 
#print(p)       
```


skip <- TRUE
if (!skip) {
# Interactive plots
require(rCharts)
rPlot(paper ~ publication.year, data = df2, type = 'point')

# Standard economics longitudinal chart
df2$Place <- rep("Place", nrow(df2))
df3 <- transform(df2, date = as.character(publication.year))
dfs <- spread(df3, Place, paper)
dfs$date <- as.numeric(as.character(dfs$date))
m1 <- mPlot(x = 'date', y = c('Place'), type = 'Line', data = dfs)
m1$set(pointSize = 1, lineWidth = 1)
m1$publish('Scatterplot', host = 'gist') 
}

## Document dimensions over years 

Number of documents for each decade-size combination are shown by n (point size).

```{r dimoveryear, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, fig.width=10, fig.height=7}
df2 <- df %>% group_by(publication.decade, document.dimension.gatherings.estimated) %>% tally()
library(ggplot2)
theme_set(theme_bw(20))
p <- ggplot(df2, aes(x = publication.decade, y = document.dimension.gatherings.estimated, size = n))
p <- p + geom_point()
p <- p + ggtitle(paste("Document size over time (n=", sum(df2$n), ")", sep = ""))
p <- p + xlab("Publication decade")
p <- p + ylab("Document dimension (estimated)")
print(p)
```

paperconsumption-1.png
Tässä on mystisiä vuosia: 
1577 -> Ok, lähetin taulukon. Selvitellään.

df <- dftmp
inds <- which(df$publication.year == 1577)
dff <- cbind(df[inds,], df.orig[inds,])
dff <- dff[, c(26:32, 47)]
tab <- as.data.frame(dff)
write.table(tab, file = "1577.tab", quote = FALSE, sep = "\t", row.names = FALSE)

